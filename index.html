<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 헤더 부분은 변경 없음 -->
</head>
<body>
    <!-- 바디의 HTML 부분은 변경 없음 -->

    <script>
        let model, webcam, labelContainer, maxPredictions;
        let port, writer, reader;
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        // addDebugMessage, connectMicrobit, readLoop, loadModel, setupWebcam, loop 함수는 변경 없음

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }

            const highestProbClass = prediction.reduce((prev, current) => 
                (prev.probability > current.probability) ? prev : current
            );
            sendToMicrobit(highestProbClass.className);
        }

        async function classifyUploadedImage() {
            const imageUpload = document.getElementById('image-upload');
            const img = document.getElementById('uploaded-image');
            
            if (imageUpload.files && imageUpload.files[0]) {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    img.src = e.target.result;
                    img.style.display = 'block';
                    
                    img.onload = async function() {
                        const prediction = await model.predict(img);
                        for (let i = 0; i < maxPredictions; i++) {
                            const classPrediction =
                                prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                            labelContainer.childNodes[i].innerHTML = classPrediction;
                        }

                        const highestProbClass = prediction.reduce((prev, current) => 
                            (prev.probability > current.probability) ? prev : current
                        );
                        sendToMicrobit(highestProbClass.className);
                    }
                }
                
                reader.readAsDataURL(imageUpload.files[0]);
            }
        }

        async function sendToMicrobit(className) {
            if (writer) {
                try {
                    const data = className + '\n';
                    await writer.write(encoder.encode(data));
                    console.log('Sent to Microbit:', data);
                    addDebugMessage('Sent to Microbit: ' + data);
                } catch (error) {
                    console.error('Send error:', error);
                    addDebugMessage('Send error: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
